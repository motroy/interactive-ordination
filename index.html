<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive PCA/NMDS Plot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ml@6/dist/ml.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            width: auto;
            height: auto;
            padding: 8px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Interactive PCA & NMDS Visualization</h1>
            <p class="text-lg text-gray-600 mt-2">Upload your own dataset to visualize dimensionality reduction.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Controls -->
            <div class="lg:col-span-3 bg-white p-6 rounded-lg shadow-lg">
                <h2 class="text-2xl font-semibold mb-4 border-b pb-2">Controls</h2>

                <!-- File Upload -->
                <div class="mb-6">
                    <label for="csv-file" class="block text-sm font-medium text-gray-700 mb-2">Upload CSV File</label>
                    <input type="file" id="csv-file" accept=".csv" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                </div>

                <!-- Analysis Type -->
                <div class="mb-6">
                    <label for="analysis-type" class="block text-sm font-medium text-gray-700 mb-2">Analysis Type</label>
                    <select id="analysis-type" class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="pca">PCA</option>
                        <option value="nmds" disabled>NMDS (coming soon)</option>
                    </select>
                </div>

                <!-- Column Selection -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Columns for Analysis</label>
                    <div id="column-selection" class="space-y-2 max-h-48 overflow-y-auto">
                        <!-- Checkboxes will be populated by JS -->
                    </div>
                </div>

                <!-- Grouping Variable -->
                 <div class="mb-6">
                    <label for="grouping-variable" class="block text-sm font-medium text-gray-700 mb-2">Grouping Variable</label>
                    <select id="grouping-variable" class="block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                        <!-- Options will be populated by JS -->
                    </select>
                </div>

                <button id="run-analysis" class="w-full bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 disabled:bg-gray-400" disabled>Run Analysis</button>

                <!-- Plot Options -->
                <div id="plot-options" class="mt-8 pt-4 border-t hidden">
                     <h3 class="text-xl font-semibold mb-4">Plot Options</h3>
                     <!-- Point Size -->
                     <div class="mb-4">
                         <label for="point-size" class="block text-sm font-medium text-gray-700">Point Size: <span id="point-size-value">5</span></label>
                         <input type="range" id="point-size" min="1" max="15" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                     </div>
                     <!-- Show Biplot -->
                     <div class="flex items-center">
                        <input id="show-biplot" type="checkbox" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500">
                        <label for="show-biplot" class="ml-2 block text-sm text-gray-900">Show Biplot</label>
                    </div>
                </div>

            </div>

            <!-- Plot -->
            <div class="lg:col-span-9 bg-white p-6 rounded-lg shadow-lg">
                <div id="plot-container" class="w-full h-[600px]">
                    <svg id="plot-svg" class="w-full h-full"></svg>
                </div>
                 <div id="message-box" class="mt-4 text-center text-red-500 font-semibold"></div>
            </div>
        </div>
    </div>

    <div class="tooltip"></div>

    <script>
        // --- Global State ---
        let rawData = [];
        let headers = [];
        let analysisResults = null; // To store PCA/NMDS results
        let selectedColumnsForAnalysis = [];

        // --- DOM Elements ---
        const fileInput = document.getElementById('csv-file');
        const analysisSelect = document.getElementById('analysis-type');
        const columnSelectionDiv = document.getElementById('column-selection');
        const groupingVariableSelect = document.getElementById('grouping-variable');
        const runButton = document.getElementById('run-analysis');
        const plotSvg = d3.select("#plot-svg");
        const messageBox = document.getElementById('message-box');
        const tooltip = d3.select(".tooltip");
        const plotOptionsDiv = document.getElementById('plot-options');
        const pointSizeSlider = document.getElementById('point-size');
        const pointSizeValue = document.getElementById('point-size-value');
        const showBiplotCheckbox = document.getElementById('show-biplot');


        // --- Event Listeners ---
        fileInput.addEventListener('change', handleFileUpload);
        runButton.addEventListener('click', runAnalysis);
        groupingVariableSelect.addEventListener('change', () => {
            if (analysisResults) drawScatterPlot();
        });
        pointSizeSlider.addEventListener('input', (event) => {
            pointSizeValue.textContent = event.target.value;
            if (analysisResults) drawScatterPlot();
        });
        showBiplotCheckbox.addEventListener('change', () => {
            if (analysisResults) drawScatterPlot();
        });


        // --- Functions ---

        /**
         * Handles the file upload event.
         * Parses the CSV file and populates the UI controls.
         */
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                try {
                    const parsedData = d3.csvParse(text, d3.autoType);
                    if (parsedData.length === 0) throw new Error("CSV file is empty or could not be parsed.");
                    rawData = parsedData;
                    headers = rawData.columns;
                    
                    populateColumnSelectors();
                    runButton.disabled = false;
                    messageBox.textContent = '';
                    plotOptionsDiv.classList.add('hidden');
                    plotSvg.selectAll("*").remove();
                    analysisResults = null;
                } catch (error) {
                    messageBox.textContent = `Error parsing file: ${error.message}`;
                    runButton.disabled = true;
                }
            };
            reader.onerror = function() {
                messageBox.textContent = 'Error reading file.';
                runButton.disabled = true;
            }
            reader.readAsText(file);
        }

        /**
         * Populates the column selection checkboxes and grouping variable dropdown.
         */
        function populateColumnSelectors() {
            columnSelectionDiv.innerHTML = '';
            groupingVariableSelect.innerHTML = '<option value="">None</option>';

            headers.forEach(header => {
                const isNumeric = rawData.every(d => d[header] === null || typeof d[header] === 'number');
                
                // Populate column checkboxes only for numeric columns
                if (isNumeric) {
                    const checkboxContainer = document.createElement('div');
                    checkboxContainer.className = 'flex items-center';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `col-${header}`;
                    checkbox.value = header;
                    checkbox.checked = true;
                    checkbox.className = 'h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500';
                    const label = document.createElement('label');
                    label.htmlFor = `col-${header}`;
                    label.textContent = header;
                    label.className = 'ml-2 block text-sm text-gray-900';
                    checkboxContainer.appendChild(checkbox);
                    checkboxContainer.appendChild(label);
                    columnSelectionDiv.appendChild(checkboxContainer);
                }

                // Populate grouping variable dropdown with all columns
                const option = document.createElement('option');
                option.value = header;
                option.textContent = header;
                groupingVariableSelect.appendChild(option);
            });
        }

        /**
         * Runs the selected analysis (PCA or NMDS).
         */
        function runAnalysis() {
            if (rawData.length === 0) {
                 messageBox.textContent = 'Please upload a dataset first.';
                return;
            }

            selectedColumnsForAnalysis = Array.from(columnSelectionDiv.querySelectorAll('input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            if (selectedColumnsForAnalysis.length < 2) {
                messageBox.textContent = 'Please select at least two numeric columns for analysis.';
                return;
            }

            const analysisType = analysisSelect.value;
            const numericData = rawData.map(row => selectedColumnsForAnalysis.map(col => row[col]));

            if (analysisType === 'pca') {
                try {
                    analysisResults = performPCA(numericData);
                } catch (error) {
                    messageBox.textContent = `PCA Error: ${error.message}`;
                    console.error(error);
                    analysisResults = null;
                    return;
                }
            } else {
                messageBox.textContent = 'NMDS is not yet implemented.';
                return;
            }
            
            messageBox.textContent = ''; // Clear any previous error messages
            plotOptionsDiv.classList.remove('hidden'); // Show plot options
            drawScatterPlot();
        }

        /**
         * Performs PCA on the given data.
         * @param {Array<Array<number>>} data - The input data matrix.
         * @returns {object} - An object containing the projected data and loadings.
         */
        function performPCA(data) {
            const pca = new ML.PCA(data);
            const projectedData = pca.predict(data).to2DArray();
            const loadings = pca.getLoadings().to2DArray();
            
            return { data: projectedData, loadings: loadings.slice(0, 2) }; // Return PC1 and PC2 loadings
        }

        /**
         * Draws the scatter plot using D3.js based on global state.
         */
        function drawScatterPlot() {
            if (!analysisResults) return;

            const { data, loadings } = analysisResults;
            const loadingLabels = selectedColumnsForAnalysis;

            plotSvg.selectAll("*").remove(); // Clear previous plot

            const margin = { top: 40, right: 40, bottom: 60, left: 60 };
            const width = plotSvg.node().getBoundingClientRect().width - margin.left - margin.right;
            const height = plotSvg.node().getBoundingClientRect().height - margin.top - margin.bottom;

            const g = plotSvg.append("g").attr("transform", `translate(${margin.left},${margin.top})`);

            // --- Scales ---
            const xExtent = d3.extent(data, d => d[0]);
            const yExtent = d3.extent(data, d => d[1]);
            const buffer = 0.1;
            const xScale = d3.scaleLinear()
                .domain([xExtent[0] - (xExtent[1] - xExtent[0]) * buffer, xExtent[1] + (xExtent[1] - xExtent[0]) * buffer])
                .range([0, width]);

            const yScale = d3.scaleLinear()
                .domain([yExtent[0] - (yExtent[1] - yExtent[0]) * buffer, yExtent[1] + (yExtent[1] - yExtent[0]) * buffer])
                .range([height, 0]);
            
            const groupingColumn = groupingVariableSelect.value;
            const colorScale = groupingColumn ? d3.scaleOrdinal(d3.schemeCategory10).domain([...new Set(rawData.map(d => d[groupingColumn]))]) : () => "steelblue";


            // --- Axes ---
            const xAxis = d3.axisBottom(xScale);
            const yAxis = d3.axisLeft(yScale);

            g.append("g")
                .attr("transform", `translate(0,${height})`)
                .call(xAxis)
                .append("text")
                .attr("y", 40)
                .attr("x", width / 2)
                .attr("text-anchor", "middle")
                .attr("fill", "black")
                .attr("font-weight", "bold")
                .text("PC1");

            g.append("g")
                .call(yAxis)
                .append("text")
                .attr("transform", "rotate(-90)")
                .attr("y", -40)
                .attr("x", -height / 2)
                .attr("text-anchor", "middle")
                .attr("fill", "black")
                .attr("font-weight", "bold")
                .text("PC2");

            // --- Data Points ---
            const currentPointSize = pointSizeSlider.value;
            g.selectAll(".dot")
                .data(data)
                .enter().append("circle")
                .attr("class", "dot")
                .attr("cx", d => xScale(d[0]))
                .attr("cy", d => yScale(d[1]))
                .attr("r", currentPointSize)
                .style("fill", (d, i) => groupingColumn ? colorScale(rawData[i][groupingColumn]) : "steelblue")
                .style("opacity", 0.8)
                .on("mouseover", function(event, d) {
                    d3.select(this).attr("r", parseFloat(currentPointSize) + 3);
                    tooltip.transition().duration(200).style("opacity", .9);
                    const i = data.indexOf(d);
                    const group = groupingColumn ? `${groupingColumn}: ${rawData[i][groupingColumn]}` : '';
                    tooltip.html(`PC1: ${d[0].toFixed(2)}<br/>PC2: ${d[1].toFixed(2)}<br/>${group}`)
                        .style("left", (event.pageX + 5) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", function(d) {
                    d3.select(this).attr("r", currentPointSize);
                    tooltip.transition().duration(500).style("opacity", 0);
                });

            // --- Loadings (Biplot) ---
            if (showBiplotCheckbox.checked && loadings && loadingLabels) {
                 const loadingGroup = g.append("g").attr("class", "loadings");
                 // Find a sensible scaling factor for the arrows
                 const maxDataExtent = Math.max(xExtent[1] - xExtent[0], yExtent[1] - yExtent[0]);
                 const maxAbsLoading = Math.max(...loadings.flat().map(Math.abs));
                 const scaleFactor = (maxDataExtent / maxAbsLoading) * 0.7;


                 loadingGroup.selectAll(".loading-vector")
                    .data(loadings[0].map((_, i) => ({x: loadings[0][i], y: loadings[1][i], label: loadingLabels[i]})))
                    .enter()
                    .append("g")
                    .attr("class", "loading-vector")
                    .each(function(d) {
                        const group = d3.select(this);
                        group.append("line")
                            .attr("x1", xScale(0))
                            .attr("y1", yScale(0))
                            .attr("x2", xScale(d.x * scaleFactor))
                            .attr("y2", yScale(d.y * scaleFactor))
                            .attr("stroke", "red")
                            .attr("stroke-width", 2)
                            .attr("marker-end", "url(#arrow)");
                        
                        group.append("text")
                            .attr("x", xScale(d.x * scaleFactor) + 5)
                            .attr("y", yScale(d.y * scaleFactor))
                            .text(d.label)
                            .attr("fill", "red")
                            .attr("font-size", "12px");
                    });
                
                plotSvg.append("defs").append("marker")
                    .attr("id", "arrow")
                    .attr("viewBox", "0 -5 10 10")
                    .attr("refX", 5)
                    .attr("refY", 0)
                    .attr("markerWidth", 4)
                    .attr("markerHeight", 4)
                    .attr("orient", "auto")
                    .append("path")
                    .attr("d", "M0,-5L10,0L0,5")
                    .attr("class","arrowHead")
                    .style("fill", "red");
            }
             // --- Legend ---
            if (groupingColumn) {
                const legend = g.append("g")
                    .attr("class", "legend")
                    .attr("transform", `translate(${width - 120}, 0)`);

                const legendItems = legend.selectAll(".legend-item")
                    .data(colorScale.domain())
                    .enter().append("g")
                    .attr("class", "legend-item")
                    .attr("transform", (d, i) => `translate(0, ${i * 20})`);

                legendItems.append("rect")
                    .attr("x", 0)
                    .attr("width", 15)
                    .attr("height", 15)
                    .style("fill", colorScale);

                legendItems.append("text")
                    .attr("x", 20)
                    .attr("y", 12)
                    .text(d => d)
                    .style("font-size", "12px");
            }
        }

    </script>
</body>
</html>
